# Depth Anything 3 用户使用手册

**版本：** 1.0
**更新时间：** 2026-01-31

---

## 快速开始

### 启动 WebUI（推荐）

最简单的使用方式是通过 Web 界面：

```bash
./start_app.sh
```

启动后，在浏览器中访问：**http://localhost:7860**

> **提示：** 启动脚本会自动处理端口冲突和 GPU 内存清理，无需手动干预。

---

## WebUI 使用指南

### 界面概览

WebUI 提供了直观的图形界面，支持以下功能：

1. **场景选择** - 从示例场景中选择或上传自己的数据
2. **分辨率设置** - 选择低分辨率（快速）或高分辨率（高质量）
3. **3D 可视化** - 查看深度图和相机位姿
4. **点云过滤** - 调整置信度阈值和背景颜色
5. **3D 高斯溅射** - 生成高质量的 3D 重建

### 基本操作流程

#### 1. 上传数据

**支持的输入类型：**
- 单张图像（JPG, PNG, HEIF 等）
- 多张图像（ZIP 压缩包或逐个上传）
- 视频文件（MP4, AVI, MOV 等）
- COLMAP 数据（包含 images/ 和 sparse/ 目录）

**操作步骤：**
1. 点击"上传"按钮
2. 选择文件或拖拽文件到上传区域
3. 等待文件上传完成

#### 2. 配置参数

**分辨率选择：**
- **低分辨率（Low）**：处理速度快，适合快速预览
- **高分辨率（High）**：质量更好，但处理时间更长

**高级选项：**
- **置信度阈值**：过滤低置信度的深度点（默认：40%）
- **最大点数**：限制点云大小（默认：1,000,000）
- **背景颜色**：选择黑色或白色背景

#### 3. 运行处理

1. 点击"运行"或"Process"按钮
2. 等待处理完成（进度会显示在界面上）
3. 查看结果

#### 4. 查看结果

**输出内容：**
- **深度图**：彩色编码的深度可视化
- **置信度图**：显示深度估计的可靠性
- **3D 点云**：可交互的 3D 可视化
- **相机轨迹**：相机位姿的 3D 展示

**交互操作：**
- 鼠标左键拖拽：旋转视角
- 鼠标滚轮：缩放
- 鼠标右键拖拽：平移视角

#### 5. 下载结果

点击下载按钮，可以获取以下格式的输出：
- **GLB 文件**：3D 点云（可在 Blender、Three.js 等工具中打开）
- **PLY 文件**：点云数据
- **NPZ 文件**：深度图、置信度图、相机参数的 NumPy 数组

---

## 命令行使用指南

### 基本命令格式

```bash
da3 <命令> <输入路径> [选项]
```

### 自动检测模式（推荐）

自动识别输入类型并处理：

```bash
da3 auto <输入路径>
```

**示例：**
```bash
# 处理单张图像
da3 auto image.jpg

# 处理图像目录
da3 auto images/

# 处理视频
da3 auto video.mp4

# 处理 COLMAP 数据
da3 auto colmap_project/
```

---

### 单张图像处理

```bash
da3 image <图像路径> [选项]
```

**示例：**
```bash
# 基本用法
da3 image photo.jpg

# 指定输出目录
da3 image photo.jpg --export-dir results/

# 选择输出格式
da3 image photo.jpg --export-format glb

# 使用不同的模型
da3 image photo.jpg --model-dir models/da3-large
```

**常用选项：**
- `--export-dir` - 输出目录（默认：自动生成时间戳目录）
- `--export-format` - 输出格式（glb, ply, npz, mini_npz-glb 等）
- `--model-dir` - 模型路径（默认：models/da3nested-giant-large-1.1）
- `--process-res` - 处理分辨率（默认：1024）

---

### 批量图像处理

```bash
da3 images <图像目录> [选项]
```

**示例：**
```bash
# 处理目录中的所有图像
da3 images photos/

# 指定输出格式
da3 images photos/ --export-format npz-glb

# 自动清理已存在的输出目录
da3 images photos/ --auto-cleanup
```

**注意事项：**
- 图像会按文件名排序处理
- 支持的格式：JPG, PNG, HEIF, BMP, TIFF 等
- 建议图像命名有序（如：001.jpg, 002.jpg）

---

### 视频处理

```bash
da3 video <视频路径> [选项]
```

**示例：**
```bash
# 基本用法（默认每秒提取 1 帧）
da3 video video.mp4

# 指定采样帧率
da3 video video.mp4 --fps 2.0

# 指定时间范围
da3 video video.mp4 --s-time-interval 10,30
```

**常用选项：**
- `--fps` - 采样帧率（默认：1.0，即每秒 1 帧）
- `--s-time-interval` - 时间范围（格式：开始秒,结束秒）
- `--export-format` - 输出格式

**处理流程：**
1. 从视频中提取帧
2. 对每一帧进行深度估计
3. 估计相机位姿
4. 生成 3D 重建

---

### COLMAP 数据处理

```bash
da3 colmap <COLMAP目录> [选项]
```

**示例：**
```bash
# 基本用法
da3 colmap colmap_project/

# 指定 sparse 子目录
da3 colmap colmap_project/ --sparse-subdir 0

# 使用已知的相机参数
da3 colmap colmap_project/ --use-extrinsics
```

**目录结构要求：**
```
colmap_project/
├── images/           # 图像文件
│   ├── image1.jpg
│   ├── image2.jpg
│   └── ...
└── sparse/           # COLMAP 重建结果
    └── 0/            # 或其他子目录
        ├── cameras.bin
        ├── images.bin
        └── points3D.bin
```

**常用选项：**
- `--sparse-subdir` - sparse 子目录名称（默认：0）
- `--use-extrinsics` - 使用 COLMAP 的相机外参
- `--align-poses` - 对齐预测的位姿到输入尺度

---

## 输出说明

### 输出目录结构

默认输出目录格式：`outputs/outputs_YYYYMMDDHHMMSS/`

**示例：**
```
outputs/outputs_20260131173421/
├── depth/              # 深度图（彩色可视化）
│   ├── 000.png
│   ├── 001.png
│   └── ...
├── confidence/         # 置信度图
│   ├── 000.png
│   ├── 001.png
│   └── ...
├── scene.glb          # 3D 点云（GLB 格式）
├── scene.ply          # 3D 点云（PLY 格式）
├── scene.npz          # 深度和相机数据（NumPy）
└── cameras.json       # 相机参数（JSON）
```

### 输出格式说明

#### GLB 格式（推荐）

- **用途**：3D 可视化和 Web 展示
- **包含**：点云、相机位姿、颜色信息
- **打开方式**：
  - 在线查看器：https://gltf-viewer.donmccurdy.com/
  - Blender：File → Import → glTF 2.0
  - Three.js：可直接加载到 Web 应用

#### PLY 格式

- **用途**：点云数据交换
- **包含**：3D 点坐标、颜色、法线
- **打开方式**：
  - CloudCompare
  - MeshLab
  - Open3D

#### NPZ 格式

- **用途**：深度学习和数据分析
- **包含**：
  - `depth`: 深度图数组（H×W）
  - `confidence`: 置信度图数组（H×W）
  - `intrinsics`: 相机内参矩阵（3×3）
  - `extrinsics`: 相机外参矩阵（N×4×4）
  - `fov`: 视场角（2D）

**读取示例：**
```python
import numpy as np

# 加载数据
data = np.load('scene.npz')

# 访问深度图
depth = data['depth']  # shape: (H, W)

# 访问相机参数
intrinsics = data['intrinsics']  # shape: (3, 3)
extrinsics = data['extrinsics']  # shape: (N, 4, 4)
```

---

## 高级功能

### 3D 高斯溅射（3DGS）

生成高质量的 3D 重建和新视角合成：

```bash
da3 auto input/ --infer-gs --gs-trj-mode smooth
```

**参数说明：**
- `--infer-gs` - 启用 3D 高斯溅射
- `--gs-trj-mode` - 轨迹模式：
  - `smooth` - 平滑相机路径
  - `orbit` - 环绕轨迹
- `--gs-video-quality` - 视频质量（1-10，默认：5）

**输出：**
- 高质量的 3D 重建
- 新视角渲染视频
- 可交互的 3D 模型

---

### 后端服务模式

启动后端服务，支持远程调用：

```bash
# 启动后端
da3 backend --host 0.0.0.0 --port 8008

# 使用后端进行推理（另一个终端）
da3 auto input.jpg --use-backend --backend-url http://localhost:8008
```

**优势：**
- 模型只需加载一次
- 支持多客户端并发请求
- 适合生产环境部署

---

### 画廊查看器

查看历史处理结果：

```bash
da3 gallery --gallery-dir workspace/gallery --port 8007
```

在浏览器中访问：**http://localhost:8007**

**功能：**
- 浏览所有处理过的场景
- 查看深度图和 3D 可视化
- 下载结果文件
- 比较不同处理结果

---

## 常见问题

### Q1: 如何提高处理速度？

**方法：**
1. 降低处理分辨率：`--process-res 512`
2. 使用较小的模型：`--model-dir models/da3-large`
3. 减少输出格式：`--export-format mini_npz-glb`
4. 限制点云大小：`--num-max-points 500000`

### Q2: 内存不足怎么办？

**解决方案：**
1. 降低处理分辨率
2. 减少批处理大小
3. 关闭其他占用 GPU 的程序
4. 使用 `--process-res 512` 或更低

### Q3: 深度图质量不好？

**改进方法：**
1. 提高处理分辨率：`--process-res 2048`
2. 使用更大的模型：`--model-dir models/da3-giant-1.1`
3. 调整置信度阈值：`--conf-thresh-percentile 30`
4. 确保输入图像清晰、光照良好

### Q4: 相机位姿不准确？

**解决方案：**
1. 使用 COLMAP 预处理获取准确位姿
2. 启用位姿对齐：`--align-poses`
3. 确保图像序列连续、重叠度高
4. 避免纯旋转或纯平移的相机运动

### Q5: 如何批量处理大量数据？

**推荐方案：**
```bash
# 使用后端服务模式
da3 backend --host 0.0.0.0 --port 8008 &

# 批量处理（使用后端）
for dir in data/*/; do
    da3 auto "$dir" --use-backend --backend-url http://localhost:8008
done
```

### Q6: 输出文件在哪里？

**默认位置：**
- 输出目录：`outputs/outputs_YYYYMMDDHHMMSS/`
- 时间戳格式：年月日时分秒（如：20260131173421）

**自定义位置：**
```bash
da3 auto input.jpg --export-dir my_results/
```

### Q7: 如何停止 WebUI？

**方法：**
1. 在终端按 `Ctrl+C`
2. 或者运行：`lsof -ti:7860 | xargs kill -9`

### Q8: 端口被占用怎么办？

**自动处理：**
使用 `./start_app.sh` 会自动处理端口冲突

**手动处理：**
```bash
# 查找占用端口的进程
lsof -ti:7860

# 终止进程
kill -9 $(lsof -ti:7860)
```

---

## 性能优化建议

### 针对不同场景的配置

#### 快速预览（速度优先）
```bash
da3 auto input/ \
    --process-res 512 \
    --export-format mini_npz-glb \
    --num-max-points 500000
```

#### 高质量输出（质量优先）
```bash
da3 auto input/ \
    --process-res 2048 \
    --export-format npz-glb \
    --conf-thresh-percentile 30 \
    --infer-gs
```

#### 批量处理（效率优先）
```bash
# 启动后端
da3 backend --port 8008 &

# 批量处理
da3 auto input/ \
    --use-backend \
    --backend-url http://localhost:8008 \
    --auto-cleanup
```

---

## 技术支持

### 获取帮助

```bash
# 查看所有命令
da3 --help

# 查看特定命令的帮助
da3 image --help
da3 video --help
da3 colmap --help
```

### 报告问题

如果遇到问题，请提供以下信息：
1. 错误信息（完整的终端输出）
2. 输入数据类型和大小
3. 使用的命令和参数
4. 系统环境（GPU 型号、内存大小等）

### 相关资源

- **原始项目**：https://github.com/ByteDance-Seed/Depth-Anything-3
- **WebUI 版本**：https://github.com/kegeai888/depth-anything-3-WebUI
- **论文**：arXiv:2511.10647
- **Hugging Face**：https://huggingface.co/depth-anything
- **WebUI二次开发**：科哥 | 微信：312088415 | 公众号：科哥玩AI

---

## 使用技巧

### 1. 选择合适的输入

**最佳实践：**
- 图像分辨率：1080p 或更高
- 图像质量：清晰、无模糊
- 光照条件：均匀、避免过曝或欠曝
- 场景特征：纹理丰富、避免纯色区域

### 2. 优化相机轨迹

**建议：**
- 相邻图像重叠度：60-80%
- 相机运动：平滑、连续
- 避免：快速旋转、大幅度跳跃
- 覆盖：多角度、全方位

### 3. 后处理优化

**工具推荐：**
- **点云处理**：CloudCompare, MeshLab
- **3D 编辑**：Blender
- **数据分析**：Python + NumPy + Open3D

### 4. 结果验证

**检查项：**
- 深度图是否连续、平滑
- 置信度图是否合理（高置信度区域应该多）
- 3D 点云是否完整、无明显错误
- 相机轨迹是否符合实际运动

---

## 快速参考

### 常用命令速查

```bash
# 启动 WebUI
./start_app.sh

# 处理单张图像
da3 image photo.jpg

# 处理视频（每秒 2 帧）
da3 video video.mp4 --fps 2.0

# 处理图像目录
da3 images photos/

# 处理 COLMAP 数据
da3 colmap project/ --sparse-subdir 0

# 启动后端服务
da3 backend --port 8008

# 查看画廊
da3 gallery --port 8007
```

### 常用参数速查

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--export-dir` | 输出目录 | 自动生成时间戳 |
| `--export-format` | 输出格式 | glb |
| `--process-res` | 处理分辨率 | 1024 |
| `--model-dir` | 模型路径 | models/da3nested-giant-large-1.1 |
| `--conf-thresh-percentile` | 置信度阈值 | 40.0 |
| `--num-max-points` | 最大点数 | 1000000 |
| `--fps` | 视频采样帧率 | 1.0 |
| `--infer-gs` | 启用 3DGS | False |

---

**祝您使用愉快！** 🎉
